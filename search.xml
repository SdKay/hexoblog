<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>音乐分享-故乡 by 许巍</title>
      <link href="/blog/life/%E9%9F%B3%E4%B9%90%E5%88%86%E4%BA%AB-%E6%95%85%E4%B9%A1/"/>
      <url>/blog/life/%E9%9F%B3%E4%B9%90%E5%88%86%E4%BA%AB-%E6%95%85%E4%B9%A1/</url>
      
        <content type="html"><![CDATA[<center><div class="audio"><audio controls preload><source src='https://music.163.com/song/media/outer/url?id=168107.mp3' type='audio/mp3'>Your browser does not support the audio tag.</audio></div></center><figure class="highlight md"><figcaption><span>故乡-许巍</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">天边夕阳再次映上 我的脸庞</span><br><span class="line">再次映着我那 不安的心</span><br><span class="line">这是什么地方 依然是如此的荒凉</span><br><span class="line">那无尽的旅程 如此漫长</span><br><span class="line">我是永远向着远方 独行的浪子</span><br><span class="line">你是茫茫人海之中 我的女人</span><br><span class="line">在异乡的路上 每一个寒冷的夜晚</span><br><span class="line">这思念它如刀 让我伤痛</span><br><span class="line">总是在梦里 我看到你无助的双眼</span><br><span class="line">我的心 又一次被唤醒</span><br><span class="line">我站在这里 想起和你曾经离别情景</span><br><span class="line">你站在 人群中间 那么孤单</span><br><span class="line">那是你 破碎的心</span><br><span class="line">我的心 却那么狂野</span><br><span class="line"></span><br><span class="line">你在我的心里 永远是故乡</span><br><span class="line">你总为我独自守候 沉默等待</span><br><span class="line">在异乡的路上 每一个寒冷的夜晚</span><br><span class="line">这思念它如刀 让我伤痛</span><br><span class="line">总是在梦里 我看到你无助的双眼</span><br><span class="line">我的心 又一次被唤醒</span><br><span class="line">我站在这里 想起和你曾经离别情景</span><br><span class="line">你站在 人群中间 那么孤单</span><br><span class="line">那是你 破碎的心</span><br><span class="line">我的心 却那么狂野</span><br><span class="line">总是在梦里 我看到你无助的双眼</span><br><span class="line">我的心 又一次被唤醒</span><br><span class="line">总是在梦里 看到自己走在归乡路上</span><br><span class="line">你站在 夕阳下面 容颜娇艳</span><br><span class="line">那是你 衣裙漫飞</span><br><span class="line">那是你 温柔如水</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> life </category>
          
      </categories>
      
      
        <tags>
            
            <tag> music </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>c_cpp基础-变量作用域</title>
      <link href="/blog/cpp_foundation/c_cpp%E5%9F%BA%E7%A1%80-%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F/"/>
      <url>/blog/cpp_foundation/c_cpp%E5%9F%BA%E7%A1%80-%E5%8F%98%E9%87%8F%E4%BD%9C%E7%94%A8%E5%9F%9F/</url>
      
        <content type="html"><![CDATA[<blockquote><p>变量的作用域作为变量的一个重要的属性，在使用中有许多细节值得深入学习</p></blockquote><h2 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h2><div class="story post-story"><ul><li>变量作用域：变量在代码中可见的区域</li><li>全局作用域：在全局范围(整个program)可见的区域</li><li>局部作用域：在局部范围可见的区域</li><li>文件作用域：在文件范围内的代码可见的区域</li></ul></div><h2 id="变量作用域"><a href="#变量作用域" class="headerlink" title="变量作用域"></a>变量作用域</h2><div class="story post-story"><ul><li>全局变量：具有全局作用域的变量</li><li>局部变量：具有局部作用域的变量</li></ul></div><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><div class="story post-story"><ul><li>全局变量：未初始化的全局变量编译器会为其设置默认值0(为什么？参考推荐阅读或阅读原文)</li><li>局部变量：未初始化时其值是未定义的</li></ul><h4 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h4><ul><li><a href="/blog/LinkLoadLibrary/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E5%85%BB-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90(1)/" title="目标文件组成(1)">目标文件组成(1)</a></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> c/cpp基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cpp </tag>
            
            <tag> 作用域 </tag>
            
            <tag> 基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-Singleton</title>
      <link href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Singleton/"/>
      <url>/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Singleton/</url>
      
        <content type="html"><![CDATA[<h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><div class="story post-story"><ul><li>在软件系统中，经常有这样一些特殊的类，必须保证它们在系统中只存在一个实例，才能保证它们的逻辑正确性、以及良好的效率。</li><li>如果绕过常规的构造器，提供一种机制来保证一个类只有一个实例。</li><li>这应该是类设计者的责任，而不是使用者的责任。</div><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><div class="story post-story"></li><li>保证一个类仅有一个实例，并提供一个该实例的全局访问点。</div><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><div class="story post-story"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Singleton</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>(<span class="keyword">const</span> Singleton &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> Singleton* <span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> Singleton* m_instance;</span><br><span class="line">    <span class="built_in">Singleton</span>() = <span class="keyword">delete</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Singleton* Singleton::m_instance = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Singleton* <span class="title">Singleton::getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        m_instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    retrun m_instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="第一个注意的问题"><a href="#第一个注意的问题" class="headerlink" title="第一个注意的问题"></a>第一个注意的问题</h2><div class="story post-story"></li><li>不能让使用者获取到可以直接创建对象的构造函数，如默认构造函数、拷贝构造函数等</li><li>需要将他们设置为私有或delete</div><h2 id="第二个注意的问题"><a href="#第二个注意的问题" class="headerlink" title="第二个注意的问题"></a>第二个注意的问题</h2><div class="story post-story"></li><li>上述版本中<code>getInstance</code>是一个线程不安全的版本，在多线程环境中使用时需要进一步改进<h3 id="改进一：锁保护"><a href="#改进一：锁保护" class="headerlink" title="改进一：锁保护"></a>改进一：锁保护</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Singleton* <span class="title">Singleton::getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Lock lock;</span><br><span class="line">    <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        m_instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    retrun m_instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>这个版本通过锁对<code>m_instance</code>进行了保护，是一个线程安全的版本</li><li>但是锁其实仅在第一次创建对象时才会起到真实的保护作用，后续锁就会影响性能</li><li>根源是因为锁不紧用在了变量写操作，同时作用到了变量读操作，产生了性能消耗<h3 id="改进二：双检查锁"><a href="#改进二：双检查锁" class="headerlink" title="改进二：双检查锁"></a>改进二：双检查锁</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Singleton* <span class="title">Singleton::getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        Lock lock;</span><br><span class="line">        <span class="keyword">if</span>(m_instance == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            m_instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    retrun m_instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>这个版本仅在第一次创建对象时锁才会起作用，后续就不会占用资源，从而避免锁的性能消耗</li><li>但是这个版本有一个隐藏很深的bug：<strong>由于内存读写reorder</strong>导致的锁失效问题</li><li>内存读写reorder<ul><li>多线程是在指令层级抢占cpu时间片的</li><li>编译器对代码指令级的优化导致实际执行顺序可能发生改变</li><li>在这个例子中<code>m_instance = new Singleton();</code>指令可能分为三个步骤：分配内存、调用构造器、返回内存地址</li><li>实际编译器优化后顺序可能为：分配内存、返回内存地址、调用构造器</li><li>如果执行到第二个步骤后，另一个线程调用<code>getInstance()</code>就会拿到一个未执行构造的对象指针，引发bug<h3 id="改进三：规避reorder问题"><a href="#改进三：规避reorder问题" class="headerlink" title="改进三：规避reorder问题"></a>改进三：规避reorder问题</h3></li></ul></li><li>编译器的支持：关键字<code>volatile</code>声明变量<code>m_instance()</code>即可</li><li>跨平台支持(c++11)<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">std::atomic&lt;Singleton*&gt; Singleton::m_instance;</span><br><span class="line">std::mutex Singleton::m_mutex;</span><br><span class="line"></span><br><span class="line"><span class="function">Singleton* <span class="title">Singleton::getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Singleton* tmp = m_instance.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">    std::<span class="built_in">atomic_thread_fence</span>(std::memory_order_acquire);<span class="comment">//获取内存fence</span></span><br><span class="line">    <span class="keyword">if</span> (tmp == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m_mutex)</span></span>;</span><br><span class="line">        tmp = m_instance.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> (tmp == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> Singleton;</span><br><span class="line">            std::<span class="built_in">atomic_thread_fence</span>(std::memory_order_release);<span class="comment">//释放内存fence</span></span><br><span class="line">            m_instance.<span class="built_in">store</span>(tmp, std::memory_order_relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="story post-story"></li><li>Singleton模式中的实例构造器可以设置为protected以允许子类派生。</li><li>Singleton模式一般不需要支持拷贝构造函数和clone接口，因为这可能导致多个对象实例，违背初衷。</li><li>如何实现多线程环境下安全的Singleton？注意对双检查锁的正确实现。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> singleton </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-Builder</title>
      <link href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Builder/"/>
      <url>/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Builder/</url>
      
        <content type="html"><![CDATA[<h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><div class="story post-story"><ul><li>在软件系统中，有时候面临着”一个复杂对象”的创建工作，其通常由各个部分的子对象用一定的算法构成；由于需求变化，这个复杂对象的<strong>各个部分经常面临这剧烈变化</strong>，但是<strong>将他们组合在一起的算法却相对稳定</strong>。</li><li>如何提供一种封装机制来<strong>隔离出复杂对象各个部分的变化</strong>，从而<strong>保持系统中的稳定构建算法不随着需求改变而改变</strong>。</div><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><div class="story post-story"></li><li>基类负责构造流程，子类负责各个部分构造的具体实现</li><li>这种思想和<strong>模板方法</strong>非常接近，只不过是专门用于构造对象的</div><h2 id="版本一：使用模板方法"><a href="#版本一：使用模板方法" class="headerlink" title="版本一：使用模板方法"></a>版本一：使用模板方法</h2><div class="story post-story"><div class="tabs" id="version1"><ul class="nav-tabs"><li class="tab active"><a class="#version1-1">product基类</a></li><li class="tab"><a class="#version1-2">product子类</a></li><li class="tab"><a class="#version1-3">客户程序</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version1-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">House</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">House</span>() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//管理构造流程</span></span><br><span class="line">        <span class="built_in">BuildPart1</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">            <span class="built_in">BuildPart2</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">bool</span> flag=<span class="built_in">BuildPart3</span>();</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            <span class="built_in">BuildPart4</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">BuildPart5</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart1</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart2</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart3</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart4</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart5</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StoneHouse</span>:</span> <span class="keyword">public</span> House&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">//实现具体的构造步骤</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart1</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart3</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart4</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart5</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    House* phouse = <span class="keyword">new</span> <span class="built_in">StoneHouse</span>();</span><br><span class="line">    phouse-&gt;<span class="built_in">init</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div></div></div><h2 id="版本二：进一步拆分"><a href="#版本二：进一步拆分" class="headerlink" title="版本二：进一步拆分"></a>版本二：进一步拆分</h2><div class="story post-story"></li><li>product成员复杂</li><li>构建流程管理与构建具体实现不想与product其他成员混在一起<div class="tabs" id="version2"><ul class="nav-tabs"><li class="tab active"><a class="#version2-1">product类</a></li><li class="tab"><a class="#version2-2">builder基类</a></li><li class="tab"><a class="#version2-3">director类</a></li><li class="tab"><a class="#version2-4">product子类</a></li><li class="tab"><a class="#version2-5">builder子类</a></li><li class="tab"><a class="#version2-6">客户程序</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version2-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">House</span>&#123;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HouseBuilder</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">House* <span class="title">GetResult</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pHouse;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">HouseBuilder</span>()&#123;&#125;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    House* pHouse;</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart1</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart2</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart3</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart4</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart5</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HouseDirector</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">HouseDirector</span>(HouseBuilder* pHouseBuilder) ： <span class="built_in">pHouseBuilder</span>(pHouseBuilder)&#123;&#125;</span><br><span class="line">    <span class="function">House* <span class="title">Construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        pHouseBuilder-&gt;<span class="built_in">BuildPart1</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">            pHouseBuilder-&gt;<span class="built_in">BuildPart2</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">bool</span> flag=pHouseBuilder-&gt;<span class="built_in">BuildPart3</span>();</span><br><span class="line">        <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">            pHouseBuilder-&gt;<span class="built_in">BuildPart4</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        pHouseBuilder-&gt;<span class="built_in">BuildPart5</span>();</span><br><span class="line">        <span class="keyword">return</span> pHouseBuilder-&gt;<span class="built_in">GetResult</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    HouseBuilder* pHouseBuilder;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-4"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StoneHouse</span>:</span> <span class="keyword">public</span> House&#123;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-5"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StoneHouseBuilder</span>:</span> <span class="keyword">public</span> HouseBuilder&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart1</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart3</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart4</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">BuildPart5</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-6"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HouseBuilder* pHouseBuilder = <span class="keyword">new</span> <span class="built_in">StoneHouseBuilder</span>();</span><br><span class="line">    HouseDirector * pHouseDirector = <span class="keyword">new</span> <span class="built_in">HouseDirector</span>(pHouseBuilder);</span><br><span class="line">    House* pHouse = pHouseDirector-&gt;<span class="built_in">Construct</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div></div></li><li>其中<code>House</code>和<code>HouseBuilder</code>均属于抽象基类，且一一对应</div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="story post-story"></li><li>类图</li></ul><img  src=//www.plantuml.com/plantuml/svg/NL0n3i8m3Dpz2e-0b0ymT00aree782Mf2q5fWnntG5N_JahQYjQJVRwpptwwYf2QjtomeSOGHm3hTOnuSKnM0cCFcE8SsYZSMTdjOG3G9bNQ2cRogNE-efdRpzqXDqhDaoopqopB9BHM_LF7-afoezZvbRJaK2KJIPAWnU91BGwEQ786Ct9NQhiHjWuKkyTJL37F1sY349eW4XeCzVADdxCwhTJUOp2l14PqBURVT4pJCMDCHbInlMm0QYiSDtm1><ul><li>Builder模式主要用于“分步骤构建一个复杂的对象”。在这其中“分步骤”是一个<strong>稳定的算法</strong>，而<strong>复杂对象的各个部分则经常变化</strong>。</li><li>变化点在哪里，封装在哪里：Builder模式主要在于应对“负载对象各个部分”的频繁需求变动；其缺点在于难以应对“分步骤”构建算法的需求变动。</li><li>在Builder模式中，要注意不同语言中构造器内调用虚函数的差别。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> builder </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cpp之坑-指针引用的模板参数</title>
      <link href="/blog/cpp-trap/cpp%E4%B9%8B%E5%9D%91-%E6%8C%87%E9%92%88%E5%BC%95%E7%94%A8%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%8F%82%E6%95%B0/"/>
      <url>/blog/cpp-trap/cpp%E4%B9%8B%E5%9D%91-%E6%8C%87%E9%92%88%E5%BC%95%E7%94%A8%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%8F%82%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<p>c++引用与const指针带来的坑</p><span id="more"></span><h2 id="起源"><a href="#起源" class="headerlink" title="起源"></a>起源</h2><div class="story post-story"><ul><li>一个平平无奇的模板函数</li><li>接收两个参数: 类型为<code>T</code>的<code>const</code>引用，一个同样参数的回调函数</li><li>直接将第一个参数传入回调<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">const</span> T &amp; data, <span class="keyword">const</span> std::function&lt;<span class="keyword">void</span>(<span class="keyword">const</span> T &amp;)&gt; &amp; callback)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">callback</span>(data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>代码看起来没有什么问题，使用一下<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span>* ptr = &amp;a;</span><br><span class="line">    foo&lt;<span class="keyword">int</span>&gt; (a,   [](<span class="keyword">const</span> <span class="keyword">int</span>  &amp; data)&#123; std::cout &lt;&lt;  data &lt;&lt; std::endl; &#125;);</span><br><span class="line">    foo&lt;<span class="keyword">int</span>*&gt;(ptr, [](<span class="keyword">const</span> <span class="keyword">int</span>* &amp; data)&#123; std::cout &lt;&lt; *data &lt;&lt; std::endl; &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>使用g++编译，第一个<code>T</code>为<code>int</code>的<code>foo</code>调用没有问题，但<code>T</code>为<code>int*</code>编译器会报错：找不到匹配的函数</li><li>初一看就很奇怪了</div><h2 id="const引用与const指针"><a href="#const引用与const指针" class="headerlink" title="const引用与const指针"></a>const引用与const指针</h2><div class="story post-story"></li><li>仔细分析下所谓<code>const引用</code>就是意味着变量不能被修改为其他值</li><li>那么<code>const引用</code>的指针也即指针不能修改为其他值，即不能指向别的区域</li><li>这里就和<code>void* const</code>这样的指针等价了</li><li>所以这里编译器应该是针对指针进行了语义转换(或者说<strong>内部引用的实现就是通过指针完成的</strong>)</li><li>这样就可以理解了，模板参数<code>int*</code>会被当做<code>int*const</code>,也就导致我们参数不一致编译失败</li><li>如此，修改起来就简单了，把<code>int*</code>改为<code>int*const</code>即可<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span>* ptr = &amp;a;</span><br><span class="line">    foo&lt;<span class="keyword">int</span>&gt; (a,   [](<span class="keyword">const</span> <span class="keyword">int</span>  &amp; data)&#123; std::cout &lt;&lt;  data &lt;&lt; std::endl; &#125;);</span><br><span class="line">    foo&lt;<span class="keyword">int</span>*<span class="keyword">const</span>&gt;(ptr, [](<span class="keyword">const</span> <span class="keyword">int</span>* <span class="keyword">const</span> &amp; data)&#123; std::cout &lt;&lt; *data &lt;&lt; std::endl; &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h2 id="没有const的引用就是普通的指针"><a href="#没有const的引用就是普通的指针" class="headerlink" title="没有const的引用就是普通的指针"></a>没有const的引用就是普通的指针</h2><div class="story post-story"></li><li>进一步验证，把<code>foo</code>对<code>T</code>的引用不使用<code>const</code></li><li>此时模板参数就可以为<code>int*</code>了<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">const</span> T &amp; data, <span class="keyword">const</span> std::function&lt;<span class="keyword">void</span>(<span class="keyword">const</span> T &amp;)&gt; &amp; cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cb</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo2</span><span class="params">(T &amp; data, <span class="keyword">const</span> std::function&lt;<span class="keyword">void</span>(T &amp;)&gt; &amp; cb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cb</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span>* ptr = &amp;a;</span><br><span class="line">    foo&lt;<span class="keyword">int</span>&gt;(a, [](<span class="keyword">const</span> <span class="keyword">int</span> &amp; data)&#123; std::cout &lt;&lt; data &lt;&lt; std::endl; &#125;);</span><br><span class="line">    foo&lt;<span class="keyword">int</span>*<span class="keyword">const</span>&gt;(ptr, [](<span class="keyword">const</span> <span class="keyword">int</span>* <span class="keyword">const</span> &amp; data)&#123; std::cout &lt;&lt; *data &lt;&lt; std::endl; &#125;);</span><br><span class="line">    foo2&lt;<span class="keyword">int</span>*&gt;(ptr, [](<span class="keyword">int</span>* &amp; data)&#123; std::cout &lt;&lt; *data &lt;&lt; std::endl; &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>以上</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> cpp-trap </category>
          
      </categories>
      
      
        <tags>
            
            <tag> c++ </tag>
            
            <tag> trap </tag>
            
            <tag> reference </tag>
            
            <tag> pointer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>程序员的自我修养-目标文件组成(1)</title>
      <link href="/blog/LinkLoadLibrary/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E5%85%BB-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90(1)/"/>
      <url>/blog/LinkLoadLibrary/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E5%85%BB-%E7%9B%AE%E6%A0%87%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90(1)/</url>
      
        <content type="html"><![CDATA[<h2 id="目标文件的格式"><a href="#目标文件的格式" class="headerlink" title="目标文件的格式"></a>目标文件的格式</h2><div class="story post-story"><ul><li><strong>目标文件</strong>：源码编译后但还未链接的文件</li><li>在linux平台下<strong>目标文件</strong>，<strong>可执行文件</strong>，<strong>动态链接库</strong>及<strong>静态链接库</strong>具有相似的文件结构，统称为<strong>ELF</strong>文件，在windows平台下是<strong>PE-COFF</strong>格式</li></ul></div><h2 id="目标文件的构成"><a href="#目标文件的构成" class="headerlink" title="目标文件的构成"></a>目标文件的构成</h2><div class="story post-story"><ul><li><p><strong>ELF</strong>文件由文件头、代码段(.text)、数据段(.data)及.bss段,具体作用见下图<br><img src="https://res.sdking.fun/compile/ELF-structure.svg" class="lazyload" data-srcset="https://res.sdking.fun/compile/ELF-structure.svg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p></li><li><p><code>未初始化的全局变量</code>和<code>局部静态变量</code>默认值都为0，故没必要放在<code>.data</code>段</p></li><li><p><code>.bss</code>段只是为未初始化的全局变量和局部静态变量预留位置，并没有内容，<strong>在文件中不占用空间</strong>(仅需记录预留位置的大小)</p></li><li><p>数据和代码分离的好处</p><ul><li>权限保护。指令区设置为只读， 数据区可读写</li><li>提高缓存命中率</li><li>便于资源分隔与共享</li></ul></li></ul></div><h2 id="举例-amp-工具"><a href="#举例-amp-工具" class="headerlink" title="举例&amp;工具"></a>举例&amp;工具</h2><div class="story post-story"><ul><li><p>测试代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span></span>;</span><br><span class="line"><span class="keyword">int</span> global_init_var = <span class="number">84</span>; <span class="comment">//.data段</span></span><br><span class="line"><span class="keyword">int</span> global_uninit_var;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">(<span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> static_var = <span class="number">85</span>; <span class="comment">//.data段</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> static_var2;</span><br><span class="line">  <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> b;</span><br><span class="line">  func1(static_var + static_var2 + a + b);</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>编译： <code>gcc -c test.c -o test.o</code></p></li><li><p>查看段大小：<code>size test.o</code></p></li><li><p>查看各段简短信息：<code>objdump -h test.o</code></p></li><li><p>查看各段详细信息：<code>objdump -s -x -d test.o</code></p><p>如下.data段存储的<code>global_init_var</code>和<code>static_var</code>两个值，对应16进制0x54和0x55</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Contents of section .data:</span><br><span class="line"> 0000 54000000 55000000                    T...U...</span><br></pre></td></tr></table></figure></li><li><p>使用<code>objcopy</code>将一个二进制文件写入一个elf文件段内</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objcopy -I binary -O elf64-x86-64 -B i386 test.jpeg test.o</span><br></pre></td></tr></table></figure></li><li><p>在代码中指定变量或函数存储的段</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((section(<span class="string">&quot;FOO&quot;</span>))) <span class="keyword">int</span> global = <span class="number">42</span>;</span><br><span class="line">__attribute__((section(<span class="string">&quot;BAR&quot;</span>))) <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 程序员的自我修养 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> objectfile </tag>
            
            <tag> ELF </tag>
            
            <tag> linking </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-Prototype</title>
      <link href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Prototype/"/>
      <url>/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Prototype/</url>
      
        <content type="html"><![CDATA[<h2 id="意图"><a href="#意图" class="headerlink" title="意图"></a>意图</h2><div class="story post-story"><p>用原型实例制定创建对象的种类，并且通过拷贝这些原型创建新的对象</p></div><h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><div class="story post-story"><ul><li><p>原型模式可以由<a href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-FactoryMethod/" title="工厂方法">工厂方法</a>演化而来</p></li><li><p>具体讲就是将抽象基类<code>Product</code>和<code>Creator</code>合并，并将<code>FactoryMethod</code>改为<code>clone</code>方法</p></div><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><div class="story post-story"><div class="tabs" id="origin"><ul class="nav-tabs"><li class="tab active"><a class="#origin-1">客户程序</a></li><li class="tab"><a class="#origin-2">抽象类</a></li><li class="tab"><a class="#origin-3">具体类</a></li></ul><div class="tab-content"><div class="tab-pane active" id="origin-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainForm</span> :</span> <span class="keyword">public</span> Form</span><br><span class="line">&#123;</span><br><span class="line">    ISplitter *prototype;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MainForm</span>(SplitterFactory *sf) : <span class="built_in">sf</span>(sf) &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Button_Click</span><span class="params">()</span></span>&#123;</span><br><span class="line">ISplitter * splitter = prototype-&gt;<span class="built_in">clone</span>();</span><br><span class="line">        splitter-&gt;<span class="built_in">split</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ISplitter</span>&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">ISplitter</span>()&#123;&#125;</span><br><span class="line">    ~<span class="built_in">ISplitter</span>() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">split</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ISplitter * <span class="title">clone</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinarySplitter</span> :</span> <span class="keyword">public</span> ISplitter&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function">ISplitter * <span class="title">clone</span><span class="params">()</span> <span class="title">override</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">BinarySplitter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageSplitter</span> :</span> <span class="keyword">public</span> ISplitter&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">split</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function">ISplitter * <span class="title">clone</span><span class="params">()</span> <span class="title">override</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ImageSplitter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div></li><li><p>注意客户程序中不能直接通过<code>prototype</code>调用<code>split</code>方法</p></li></ul></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="story post-story"><ul><li>类图<img  src=//www.plantuml.com/plantuml/svg/bP0x3i8m38RtdC8Z31deM04B4njN2AbR8bexIbmXL7ft-g2010Z85CdV_x3ZqP4tmLHG1AxzbWuOd1Yo28ao-oZ1M05RcXXX5rXOpXwXKT2zPfgt7S24ixbgbHhP3PCDA7ZNB6wY9_8JchoYZ-ZbHMTy8lqcuISgwMCTae0EhZY8NZ_jbOAV_aeH2yB00ETluj9qA3XKxIPr8B3ippqSiSmLKWQznrUdv4-dFOjmrK_7JGQTXzMZl5vFjxjBhm00></li></ul><ul><li><p>适用性</p><ul><li>当一个系统应该独立于它的产品创建、构成和表示时。</li><li>当要实例化的类实在运行时指定时。</li><li>为了避免创建一个与产品类层次平行的工厂类层次时。</li><li>当一个类的实例只能有几个不同状态组合中的一种时。建立相应数目的原型并克隆他们可能比每次用合适的状态手工实例化该类更方便些。</li></ul></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> factorymethod </tag>
            
            <tag> 设计模式 </tag>
            
            <tag> prototype </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo-grammar</title>
      <link href="/blog/snippet/hexo-grammar/"/>
      <url>/blog/snippet/hexo-grammar/</url>
      
        <content type="html"><![CDATA[<div class="note link"><p><strong>参考文档</strong></p><ul><li><a href="https://volantis.js.org/v5/tag-plugins/">volantis主题标签系统</a></li><li><a href="https://hexo.io/zh-cn/docs/tag-plugins">hexo官方标签系统</a></li></ul></div><span id="more"></span><h2 id="文本居中"><a href="#文本居中" class="headerlink" title="文本居中"></a>文本居中</h2><div class="story post-story"><ul><li>语法，直接调用html<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% span center small cyan, 曾经有一份真挚的爱情摆在我的面前，但是我没有珍惜， %&#125;</span><br><span class="line">&#123;% span center small cyan, 等我失去后才后悔莫及，尘世间最痛苦的事情莫过于此。 %&#125;</span><br><span class="line">&#123;% span center small cyan, 如果上天能够给我一个再来一次的机会，我会对那个女孩说三个字：我爱你。 %&#125;</span><br><span class="line">&#123;% span center small cyan, 如果非要在这份爱上加一个期限，我希望是。。。。。。一万年！ %&#125;</span><br></pre></td></tr></table></figure></li><li>效果<span class='p center small cyan'>曾经有一份真挚的爱情摆在我的面前，但是我没有珍惜，</span><span class='p center small cyan'>等我失去后才后悔莫及，尘世间最痛苦的事情莫过于此。</span><span class='p center small cyan'>如果上天能够给我一个再来一次的机会，我会对那个女孩说三个字：我爱你。</span><span class='p center small cyan'>如果非要在这份爱上加一个期限，我希望是。。。。。。一万年！</span></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> snippet </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> snippet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-AbstractFactory</title>
      <link href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-AbstractFactory/"/>
      <url>/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-AbstractFactory/</url>
      
        <content type="html"><![CDATA[<h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><div class="story post-story"><ul><li>在软件系统中，经常面临着<strong>一系列相关或相互依赖</strong>的对象的创建工作；同时，由于需求的变化，往往存在更多系列对象的创建工作。(注：系列会增多，但系列下的功能不会有变化)</li><li>如何绕过常规的对象创建方法(new)，提供一种”封装机制”来避免客户程序和这种”多系列具体对象创建工作”的紧耦合？</div><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><div class="story post-story"></li><li>提供一个接口以创建<strong>一系列相关或相互依赖</strong>的对象，而无需制定他们的具体类。</div><h2 id="引出问题"><a href="#引出问题" class="headerlink" title="引出问题"></a>引出问题</h2><div class="story post-story"></li><li>一个程序中读取数据库的内容</li><li>读取过程分几个步骤，要用到多个对象，且对象之间有<strong>关联性</strong>。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmployeeDAO</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//读取数据库的操作流程</span></span><br><span class="line">    <span class="function">vector&lt;EmployeeDO&gt; <span class="title">GetEmployees</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SqlConnection* connection = <span class="keyword">new</span> <span class="built_in">SqlConnection</span>();</span><br><span class="line">        connection-&gt;ConnectionString = <span class="string">&quot;...&quot;</span>;</span><br><span class="line"></span><br><span class="line">        SqlCommand* command = <span class="keyword">new</span> <span class="built_in">SqlCommand</span>();</span><br><span class="line">        command-&gt;CommandText=<span class="string">&quot;...&quot;</span>;</span><br><span class="line">        command-&gt;<span class="built_in">SetConnection</span>(connection);  <span class="comment">//注意这里的相关性</span></span><br><span class="line"></span><br><span class="line">        SqlDataReader* reader = command-&gt;<span class="built_in">ExecuteReader</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li>上述程序只是对sql数据库进行了支持，为了扩展更多类型的支持，这里需要使用抽象接口</li><li>此时就可以使用<a href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-FactoryMethod/" title="工厂模式">工厂模式</a>进行重构</li></ul></div><h2 id="使用工厂模式重构"><a href="#使用工厂模式重构" class="headerlink" title="使用工厂模式重构"></a>使用工厂模式重构</h2><div class="story post-story"><div class="tabs" id="version1"><ul class="nav-tabs"><li class="tab active"><a class="#version1-1">product基类</a></li><li class="tab"><a class="#version1-2">product子类</a></li><li class="tab"><a class="#version1-3">creator基类</a></li><li class="tab"><a class="#version1-4">creator子类</a></li><li class="tab"><a class="#version1-5">使用抽象接口</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version1-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内部实现忽略</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBConnection</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBConnection</span>();</span><br><span class="line">    ~<span class="built_in">IDBConnection</span>()&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBCommand</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBCommand</span>();</span><br><span class="line">    ~<span class="built_in">IDBCommand</span>()&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="title">SetConnection</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBDataReader</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBDataReader</span>();</span><br><span class="line">    ~<span class="built_in">IDBDataReader</span>()&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//for Sql server</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlConnection</span> :</span> <span class="keyword">public</span> IDBConnection &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlCommand</span>:</span>  <span class="keyword">public</span> IDBCommand &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlDataReader</span> :</span> <span class="keyword">public</span> IDBReader &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//for Oracle server</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleConnection</span> :</span> <span class="keyword">public</span> IDBConnection &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleCommand</span>:</span>  <span class="keyword">public</span> IDBCommand &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleDataReader</span> :</span> <span class="keyword">public</span> IDBDataReader &#123;&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内部实现忽略</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBConnectionFactory</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBConnectionFactory</span>();</span><br><span class="line">    ~<span class="built_in">IDBConnectionFactory</span>()&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBConnection* <span class="title">CreateIDBConnection</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBCommandFactory</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBCommandFactory</span>();</span><br><span class="line">    ~<span class="built_in">IDBCommandFactory</span>()&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBCommand* <span class="title">CreateIDBCommand</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBDataReaderFactory</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBDataReaderFactory</span>();</span><br><span class="line">    ~<span class="built_in">IDBDataReaderFactory</span>()&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBDataReader* <span class="title">CreateIDBDataReader</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-4"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内部实现忽略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for sql server</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sqlConnectionFactory</span> :</span> <span class="keyword">public</span> IDBConnectionFactory&#123;</span><br><span class="line">    <span class="function">IDBConnection* <span class="title">CreateIDBConnection</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sqlCommandFactory</span> :</span> <span class="keyword">public</span> IDBCommandFactory &#123;</span><br><span class="line">    <span class="function">IDBCommand* <span class="title">CreateIDBCommand</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sqlDataReaderFactory</span> :</span> <span class="keyword">public</span> IDBDataReaderFactory &#123;</span><br><span class="line">    <span class="function">IDBDataReader* <span class="title">CreateIDBDataReader</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//for Oracle server</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleConnectionFactory</span> :</span> <span class="keyword">public</span> IDBConnectionFactory&#123;</span><br><span class="line">    <span class="function">IDBConnection* <span class="title">CreateIDBConnection</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleCommandFactory</span> :</span> <span class="keyword">public</span> IDBCommandFactory &#123;</span><br><span class="line">    <span class="function">IDBCommand* <span class="title">CreateIDBCommand</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleDataReaderFactory</span> :</span> <span class="keyword">public</span> IDBDataReaderFactory &#123;</span><br><span class="line">    <span class="function">IDBDataReader* <span class="title">CreateIDBDataReader</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-5"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmployeeDAO</span>&#123;</span></span><br><span class="line">    <span class="comment">//通过EmployeeDAO的构造函数初始化一下三个抽象指针</span></span><br><span class="line">    IDBConnectionFactory * connectFactory;</span><br><span class="line">    IDBCommandFactory * commandFactory;</span><br><span class="line">    IDBDataReaderFactory * dataReaderFactory;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//读取数据库的操作流程</span></span><br><span class="line">    <span class="function">vector&lt;EmployeeDO&gt; <span class="title">GetEmployees</span><span class="params">()</span></span>&#123;</span><br><span class="line">        IDBConnection* connection = connectFactory-&gt;<span class="built_in">CreateIDBConnection</span>();</span><br><span class="line">        connection-&gt;ConnectionString = <span class="string">&quot;...&quot;</span>;</span><br><span class="line"></span><br><span class="line">        IDBCommand* command = commandFactory-&gt;<span class="built_in">CreateIDBCommand</span>();</span><br><span class="line">        command-&gt;CommandText=<span class="string">&quot;...&quot;</span>;</span><br><span class="line">        command-&gt;<span class="built_in">SetConnection</span>(connection);  <span class="comment">//注意这里的相关性</span></span><br><span class="line"></span><br><span class="line">        IDBDataReader* reader = dataReaderFactory-&gt;<span class="built_in">CreateIDBDataReader</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div><ul><li>代码写到这里似乎已经不错了，抽象接口和具体实现已经完成了隔离。</li><li>这里就要再次提到开头强调的<strong>一系列相关或相互依赖</strong>，在本例中，<code>IDBCommand::SetConnection</code>依赖于<code>IDBConnection</code>对象，具有关联性</li><li>具体讲就是这里三个对象应该是同一种数据库，属于高内聚的对象。<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IDBConnectionFactory * connectFactory;</span><br><span class="line">IDBCommandFactory * commandFactory;</span><br><span class="line">IDBDataReaderFactory * dataReaderFactory;</span><br></pre></td></tr></table></figure></li><li>如何处理这种情况就引出抽象工厂。</div><h2 id="使用抽象工厂重构"><a href="#使用抽象工厂重构" class="headerlink" title="使用抽象工厂重构"></a>使用抽象工厂重构</h2><div class="story post-story"></li><li>既然上述三个工厂具有相关性，那么为什么不用一个工厂来完成呢<div class="tabs" id="version2"><ul class="nav-tabs"><li class="tab active"><a class="#version2-1">product基类</a></li><li class="tab"><a class="#version2-2">product子类</a></li><li class="tab"><a class="#version2-3">creator基类</a></li><li class="tab"><a class="#version2-4">creator子类</a></li><li class="tab"><a class="#version2-5">使用抽象接口</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version2-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内部实现忽略</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBConnection</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBConnection</span>();</span><br><span class="line">    ~<span class="built_in">IDBConnection</span>()&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBCommand</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBCommand</span>();</span><br><span class="line">    ~<span class="built_in">IDBCommand</span>()&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="title">SetConnection</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBDataReader</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBDataReader</span>();</span><br><span class="line">    ~<span class="built_in">IDBDataReader</span>()&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//for Sql server</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlConnection</span> :</span> <span class="keyword">public</span> IDBConnection &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlCommand</span>:</span>  <span class="keyword">public</span> IDBCommand &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlDataReader</span> :</span> <span class="keyword">public</span> IDBReader &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//for Oracle server</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleConnection</span> :</span> <span class="keyword">public</span> IDBConnection &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleCommand</span>:</span>  <span class="keyword">public</span> IDBCommand &#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleDataReader</span> :</span> <span class="keyword">public</span> IDBDataReader &#123;&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内部实现忽略</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IDBFactory</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">IDBFactory</span>();</span><br><span class="line">    ~<span class="built_in">IDBFactory</span>()&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBConnection* <span class="title">CreateIDBConnection</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBCommand* <span class="title">CreateIDBCommand</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> IDBDataReader* <span class="title">CreateIDBDataReader</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-4"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内部实现忽略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for sql server</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlFactory</span> :</span> <span class="keyword">public</span> IDBFactory&#123;</span><br><span class="line">    <span class="function">IDBConnection* <span class="title">CreateIDBConnection</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function">IDBCommand* <span class="title">CreateIDBCommand</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function">IDBDataReader* <span class="title">CreateIDBDataReader</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//for Oracle server</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OracleFactory</span> :</span> <span class="keyword">public</span> IDBFactory&#123;</span><br><span class="line">    <span class="function">IDBConnection* <span class="title">CreateIDBConnection</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function">IDBCommand* <span class="title">CreateIDBCommand</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">    <span class="function">IDBDataReader* <span class="title">CreateIDBDataReader</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-5"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmployeeDAO</span>&#123;</span></span><br><span class="line">    <span class="comment">//通过EmployeeDAO的构造函数初始化一下三个抽象指针</span></span><br><span class="line">    IDBFactory * factory;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//读取数据库的操作流程</span></span><br><span class="line">    <span class="function">vector&lt;EmployeeDO&gt; <span class="title">GetEmployees</span><span class="params">()</span></span>&#123;</span><br><span class="line">        IDBConnection* connection = factory-&gt;<span class="built_in">CreateIDBConnection</span>();</span><br><span class="line">        connection-&gt;ConnectionString = <span class="string">&quot;...&quot;</span>;</span><br><span class="line"></span><br><span class="line">        IDBCommand* command = factory-&gt;<span class="built_in">CreateIDBCommand</span>();</span><br><span class="line">        command-&gt;CommandText=<span class="string">&quot;...&quot;</span>;</span><br><span class="line">        command-&gt;<span class="built_in">SetConnection</span>(connection);  <span class="comment">//注意这里的相关性</span></span><br><span class="line"></span><br><span class="line">        IDBDataReader* reader = factory-&gt;<span class="built_in">CreateIDBDataReader</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div></li><li>通过将高内聚的对象使用放在同一个工厂内，从而实现<strong>高内聚，松耦合</strong>。</div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="story post-story"></li><li>类图<ul><li><code>client</code> -&gt; <code>EmployeeDAO</code></li><li><code>AbstactProduct</code> -&gt; [<code>IDBConnection</code>] or [<code>IDBCommand</code>] or [<code>IDataReader</code>]</li><li><code>AbstactFactory</code> -&gt; <code>IDBFactory</code><img  src=//www.plantuml.com/plantuml/svg/bPB12iCW38RlUOeSjuE5UXw5MjXvh-2iXq5HKCSOhUy-ozfIghETu27-Vxv48xzRPxXmA3fkBTOX3D4rR6tUs0E6rVF9vB4naZjvCxfz2bUVpbcT1Tq3VCcDLi989oTqER6JmCCK-YzbSx_BG5hzKYJgxgYH0W1FFk7S3FO-xs2ZO-biILigpYVbleL671QPMBbl6JdHl8gYMlMIaqC9Y0QrJgTPUImlkeTK3WcfDbyoeSpKtnA33m00></li></ul></li><li>如果没有应对<strong>多系列对象构建</strong>的需求变化，则没有必要使用抽象工厂模式，这时候使用简单工厂模式即可</li><li><strong>系列对象</strong>指的是在某一特定系列下的对象之间有相互依赖、或作用的关系。不同系列的对象之间不能相互依赖(如上述例子中的sql和oracle)</li><li>抽象工厂模式主要在于应对<strong>新系列</strong>的需求变动，其缺点在于难以应对<strong>新对象</strong>的需求变动。</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> abstractfactory </tag>
            
            <tag> factorymethod </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>程序员的自我修养-编译链接</title>
      <link href="/blog/LinkLoadLibrary/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E5%85%BB-%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5/"/>
      <url>/blog/LinkLoadLibrary/%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E5%85%BB-%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5/</url>
      
        <content type="html"><![CDATA[<p>&lt;&lt;程序员的自我修养–链接、装载与库&gt;&gt; 读书笔记.</p><span id="more"></span><h3 id="程序构建-Build-流程"><a href="#程序构建-Build-流程" class="headerlink" title="程序构建(Build)流程"></a>程序构建(Build)流程</h3><img  src=//www.plantuml.com/plantuml/svg/RP5FIm916CRl-oa6l2tftZi44jqAWgvTfjdNRN2TsNRMe6CWheQ24Kf2XPW73uc5fzJgo-m_Jts5PcrN8vtJ-xxCCy_lUKSKAREmZKj8m4KP684Z408Ra3UfmH01ve2jd8DfyXn1sJtqMrAqYuvji6nvcJBZb25LrJHYMPgcgeZRozOWKd4GJnJ67K3y4kn4JtRIXnGaJnRvWqhOgcOe8sPPX-zv8wD3WR9bHGlXgBxeLy9v9nhV1WtNcmrIMQstw0w2oN3XtYGZx-inR7SpbesD4bQ0wIWsLvGKV9L1o0pxl6HH4pkKioJ34lfaApHDeKLY5OsRmQJjrwh1Kqk2HkFHlzPxhwzQRtxlDpgfylFETwV1coipURFdi7UzGIhMf5oIveM0qfbvbM1YiR5fiXLQfD0yiVvhwjTUWuUftntAElfu2Phz3GmUO-0SBpiIuf2oulgxJJrs_040><h3 id="编译-Compilation-流程"><a href="#编译-Compilation-流程" class="headerlink" title="编译(Compilation)流程"></a>编译(Compilation)流程</h3><img  src=//www.plantuml.com/plantuml/svg/RL9TRn9157tdLqnufd-01vEcYSO7ex7yWSam9PEMMToT6kkJROJoiRHeAfJILchz86aBrLhbI_fdTcQN9_-2Tvb5M7JVTkwvvvnxxhNM6SzW4wUHHPzjKaxe8sfPE4MNDrYA8qAve6O4488Hbi5S8ClOD0aDFIMCTSgjq5DqTOiB_08bJ4gZ25l84k7wYf5E--H9j8WaYz27leSqJJ8iA7fACoQre1CBPl190miRZ2QmcQ82hHX9JIX8k7wVSRo15b5h08leuT3IlM0c54Uh17CE6N03r8tdr0mIY4t7Hl0j8NLS6DShRl67UhMjZljkkwPktWKrcS_9mZVXmoEK9v5F5Oa42g1b2T1vWaqh9AFhCJyvJUDqYqwtfAgxgjQKsHklSmKIxj5he5Ud5LKegVPj0DKrrNmJHyxWatVMyaOZETntkdslkEFkzA0BYW7OFMlBzf5tLm7JxkLdPtWeitct_qM-jMNbmkaLvao3LJ1C9evNQHhoP0GjGvvRByCPYTXaaLfXV5A7MC0Ka6ctSIJFhzNX7cYuNmVoj2JjtZXR_ZqCVhrVbwhyOKwOQ6Lc-i9wI_xgJFGu8rYQXTM9Bmzd4Snty5xbAqxtQbpxxWpEtUQsp9MzkuPtPlkpsjNfcWfbzwBpBnfCUJzRidSZzw-dqCeUG7MtRd0RRTNS_TiWxRw_TTqpcmBimn22m12-U_I0mcbXOSoRPsRCFzb0QDXtHYVURLNpmsN9UckE4AY0S6t6-Byu18bDpZkuL1jiVXmtSkgWe-pj6TaV><h3 id="链接-Linking-流程"><a href="#链接-Linking-流程" class="headerlink" title="链接(Linking)流程"></a>链接(Linking)流程</h3><ul><li>链接的主要内容就是把各个模块之间相互引用的部分(接口&amp;变量)处理好</li><li>主要包括地址和空间分配(Address and Storage Allocation)，符号决议(Symbol Resolution)和重定位(Relocation)等这些步骤。</li><li>具体来说就是要将编译得到的<code>目标文件</code>和<code>库</code>链接形成最终的可执行文件</li></ul>]]></content>
      
      
      <categories>
          
          <category> 程序员的自我修养 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linking </tag>
            
            <tag> prepressing </tag>
            
            <tag> compile </tag>
            
            <tag> assembly </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-FactoryMethod</title>
      <link href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-FactoryMethod/"/>
      <url>/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-FactoryMethod/</url>
      
        <content type="html"><![CDATA[<h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><div class="story post-story"><ul><li><p>抽象框架感知抽象类，抽象框架必须实例化一个具体类，但抽象框架不知道哪个类要被实例化。</p></li><li><p>绕开常规创建对象方法new，提供一种”封装机制”来<strong>避免客户程序和具体对象的紧耦合</strong></p></div><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><div class="story post-story"></li><li><p>意图定义一个用于创建对象的接口，让子类决定实例化哪个类。</p></li><li><p>使一个类的实例化延迟到其子类。</p></div><h2 id="引出问题"><a href="#引出问题" class="headerlink" title="引出问题"></a>引出问题</h2><div class="story post-story"></li><li><p>一个用于文件分割的程序</p></li><li><p>变化在于对于不同的文件有不同的分割操作</p></li><li><p>以下代码中忽略了实际工程中的参数细节</p><div class="tabs" id="origin"><ul class="nav-tabs"><li class="tab active"><a class="#origin-1">客户程序</a></li><li class="tab"><a class="#origin-2">抽象类</a></li><li class="tab"><a class="#origin-3">具体类</a></li></ul><div class="tab-content"><div class="tab-pane active" id="origin-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainForm</span> :</span> <span class="keyword">public</span> Form</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Button1_Click</span><span class="params">()</span></span>&#123;</span><br><span class="line">ISplitter * splitter1= <span class="keyword">new</span> <span class="built_in">BinarySplitter</span>();<span class="comment">//依赖具体类</span></span><br><span class="line">        splitter1-&gt;<span class="built_in">split</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Button2_Click</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ISplitter * splitter2= <span class="keyword">new</span> <span class="built_in">ImageSplitter</span>();<span class="comment">//依赖具体类</span></span><br><span class="line">        splitter1-&gt;<span class="built_in">split</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Splitter</span>&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function">vitural <span class="title">split</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ~<span class="built_in">Splitter</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinarySplitter</span> :</span> <span class="keyword">public</span> Splitter&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">split</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageSplitter</span> :</span> <span class="keyword">public</span> Splitter&#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">split</span>();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div></li><li><p>该例子中<code>MainForm</code>作为<strong>高层模块</strong>中依赖于底层模块的变化，违背了<code>依赖倒置原则</code></p></li><li><p>具体讲就是<code>MainForm</code>作为抽象功能却依赖的具体的对象<code>BinarySplitter</code>和<code>ImageSplitter</code></p></div><h2 id="思路：隐藏变化-具体实现"><a href="#思路：隐藏变化-具体实现" class="headerlink" title="思路：隐藏变化(具体实现)"></a>思路：隐藏变化(具体实现)</h2><div class="story post-story"></li><li><p><code>MainForm</code>中必须要用到一个实现，但我们又要隐藏他的实现细节</p></li><li><p>利用虚函数的多态性，使用一个抽象接口来实例化具体类</p><div class="tabs" id="version1"><ul class="nav-tabs"><li class="tab active"><a class="#version1-1">客户程序</a></li><li class="tab"><a class="#version1-2">工厂类</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version1-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainForm</span> :</span> <span class="keyword">public</span> Form</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Button_Click</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SplitterFactory sf;</span><br><span class="line">ISplitter * splitter = sf.<span class="built_in">CreateSplitter</span>();<span class="comment">//依赖具体类</span></span><br><span class="line">        splitter-&gt;<span class="built_in">split</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplitterFactory</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ISplitter * <span class="title">CreateSplitter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">BinarySplitter</span>(); <span class="comment">//or new ImageSplitter()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div></li><li><p>这一版代码，虽然看似在<code>MainForm</code>隐藏了具体实现，但他依赖的<code>SplitterFactory</code>类还是要依赖具体实现，所以还需要进一步改造</p></div><h2 id="将实现放在未来"><a href="#将实现放在未来" class="headerlink" title="将实现放在未来"></a>将实现放在未来</h2><div class="story post-story"></li><li><p>将<code>SplitterFactory::CreateSplitter</code>定义为纯虚函数</p><div class="tabs" id="version2"><ul class="nav-tabs"><li class="tab active"><a class="#version2-1">客户程序</a></li><li class="tab"><a class="#version2-2">工厂基类</a></li><li class="tab"><a class="#version2-3">工厂子类</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version2-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainForm</span> :</span> <span class="keyword">public</span> Form</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Button_Click</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SplitterFactory *sf;</span><br><span class="line">ISplitter * splitter = sf-&gt;<span class="built_in">CreateSplitter</span>();</span><br><span class="line">        splitter-&gt;<span class="built_in">split</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplitterFactory</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ISplitter * <span class="title">CreateSplitter</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ~<span class="built_in">SplitterFactory</span>()&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinarySplitterFactory</span> :</span> SplitterFactory&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ISplitter * <span class="title">CreateSplitter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">BinarySplitter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageSplitterFactory</span> :</span> SplitterFactory&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ISplitter * <span class="title">CreateSplitter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ImageSplitter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div></li><li><p>此时，<code>MainForm</code>就完全不依赖具体的实现了，所有的方法都是抽象的</p></li><li><p>那么新的问题来了，<code>MainForm</code>中的<code>sf</code>如何初始化呢</p></li></ul></div><h2 id="最终的版本"><a href="#最终的版本" class="headerlink" title="最终的版本"></a>最终的版本</h2><div class="story post-story"><ul><li>通常是将<code>sf</code>作为<code>MainForm</code>的成员变量，因为他可能被多次使用</li><li>并通过<code>MainForm</code>的构造函数初始化<div class="tabs" id="version2"><ul class="nav-tabs"><li class="tab active"><a class="#version2-1">客户程序</a></li><li class="tab"><a class="#version2-2">工厂基类</a></li><li class="tab"><a class="#version2-3">工厂子类</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version2-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainForm</span> :</span> <span class="keyword">public</span> Form</span><br><span class="line">&#123;</span><br><span class="line">    SplitterFactory *sf;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MainForm</span>(SplitterFactory *sf) : <span class="built_in">sf</span>(sf) &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Button_Click</span><span class="params">()</span></span>&#123;</span><br><span class="line">ISplitter * splitter = sf-&gt;<span class="built_in">CreateSplitter</span>();</span><br><span class="line">        splitter-&gt;<span class="built_in">split</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplitterFactory</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> ISplitter * <span class="title">CreateSplitter</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">    ~<span class="built_in">SplitterFactory</span>()&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinarySplitterFactory</span> :</span> SplitterFactory&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ISplitter * <span class="title">CreateSplitter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">BinarySplitter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageSplitterFactory</span> :</span> SplitterFactory&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ISplitter * <span class="title">CreateSplitter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ImageSplitter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div></li></ul><div class="note message warning"><p><strong>一点疑问</strong></p><ul><li>既然<code>MainForm</code>可以传入多态指针，那为什么不直接传入<code>ISplitter*</code>呢，何必绕一圈？</li><li>猜想可能是<code>sf</code>中未来可能集成各种不同对象的<code>create</code></li></ul></div></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="story post-story"><ul><li>类图</li></ul><img  src=//www.plantuml.com/plantuml/svg/RKzB2i8m4Dtd55dgeZb0KK44Tw9NYCtK5agcJASKgRsxQKcG9CuY8NdpVlevCEcAPTNfOP0FGZEwromM8NICNGWq8pbCkfa3kiYhEv7UD-06pMw_mMTxxu4qjsZTpo8iCaXgNmrBh8DKMKRKZQYKskxU9pd-bL-tm1gvoWhXyw6j21Xy1n6w73w5mSaMsKB2Y_kbhbc5cFMlYeD7ijB2b5exlL_wu9lbz81masPK7TIiJbcbBm00><p>以上。</p></div>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> factorymethod </tag>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-Bridge</title>
      <link href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Bridge/"/>
      <url>/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Bridge/</url>
      
        <content type="html"><![CDATA[<hr><blockquote><p>以下笔记摘录自李建忠老师的&lt;&lt;c++设计模式&gt;&gt;和书籍&lt;&lt;设计模式&gt;&gt;</p></blockquote><h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><div class="story post-story"><ul><li>由于某些类型的固有的实现逻辑，使得它们具有两个变化的维度，乃至多个纬度的变化。</div><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><div class="story post-story"></li><li>将抽象部分(业务功能)与实现部分(平台兼容)分离，使他们都可以独立的变化。</div><h2 id="原始代码"><a href="#原始代码" class="headerlink" title="原始代码"></a>原始代码</h2><div class="story post-story"><div class="tabs" id="origin"><ul class="nav-tabs"><li class="tab active"><a class="#origin-1">抽象类</a></li><li class="tab"><a class="#origin-2">平台实现</a></li><li class="tab"><a class="#origin-3">业务抽象</a></li><li class="tab"><a class="#origin-4">使用</a></li></ul><div class="tab-content"><div class="tab-pane active" id="origin-1"><ul><li>抽象类中包含了两个维度的接口<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Messager</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Login</span><span class="params">(string username, string password)</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span></span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PlaySound</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawShape</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">WriteText</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Connect</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Messager</span>()&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></div><div class="tab-pane" id="origin-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PCMessagerBase</span> :</span> <span class="keyword">public</span> Messager&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PlaySound</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//**********</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawShape</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//**********</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">WriteText</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//**********</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Connect</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//**********</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MobileMessagerBase</span> :</span> <span class="keyword">public</span> Messager&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PlaySound</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//==========</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawShape</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//==========</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">WriteText</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//==========</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Connect</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//==========</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PCMessagerLite</span> :</span> <span class="keyword">public</span> PCMessagerBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Login</span><span class="params">(string username, string password)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PCMessagerBase::<span class="built_in">Connect</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PCMessagerBase::<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PCMessagerBase::<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PCMessagerPerfect</span> :</span> <span class="keyword">public</span> PCMessagerBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Login</span><span class="params">(string username, string password)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PCMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        PCMessagerBase::<span class="built_in">Connect</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PCMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        PCMessagerBase::<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        PCMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        PCMessagerBase::<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MobileMessagerLite</span> :</span> <span class="keyword">public</span> MobileMessagerBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Login</span><span class="params">(string username, string password)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        MobileMessagerBase::<span class="built_in">Connect</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        MobileMessagerBase::<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        MobileMessagerBase::<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MobileMessagerPerfect</span> :</span> <span class="keyword">public</span> MobileMessagerBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Login</span><span class="params">(string username, string password)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        MobileMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        MobileMessagerBase::<span class="built_in">Connect</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        MobileMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        MobileMessagerBase::<span class="built_in">WriteText</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        MobileMessagerBase::<span class="built_in">PlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        MobileMessagerBase::<span class="built_in">DrawShape</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-4"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Process</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//编译时装配</span></span><br><span class="line">    Messager *m = <span class="keyword">new</span> <span class="built_in">MobileMessagerPerfect</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div></div></li></ul></div><h2 id="重构代码"><a href="#重构代码" class="headerlink" title="重构代码"></a>重构代码</h2><div class="story post-story"><div class="tabs" id="final"><ul class="nav-tabs"><li class="tab active"><a class="#final-1">抽象类拆分并组合</a></li><li class="tab"><a class="#final-2">平台实现</a></li><li class="tab"><a class="#final-3">业务抽象</a></li><li class="tab"><a class="#final-4">使用</a></li></ul><div class="tab-content"><div class="tab-pane active" id="final-1"><ul><li>抽象类中包含了两个维度的接口<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Messager</span>&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    MessagerImp * messageImp;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Messager</span>(MessagerImp *imp) : <span class="built_in">messageImp</span>(imp) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Login</span><span class="params">(string username, string password)</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span></span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Messager</span>()&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessagerImp</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PlaySound</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawShape</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">WriteText</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Connect</span><span class="params">()</span></span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">MessagerImp</span>()&#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></div><div class="tab-pane" id="final-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PCMessagerImp</span> :</span> <span class="keyword">public</span> MessagerImp&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PlaySound</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//**********</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawShape</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//**********</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">WriteText</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//**********</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Connect</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//**********</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MobileMessagerImp</span> :</span> <span class="keyword">public</span> MessagerImp&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">PlaySound</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//==========</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">DrawShape</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//==========</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">WriteText</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//==========</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Connect</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//==========</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="final-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessagerLite</span> :</span> <span class="keyword">public</span> Messager &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MessagerLite</span>(MessagerImp* mImp) : <span class="built_in">Messager</span>(mImp) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Login</span><span class="params">(string username, string password)</span></span>&#123;</span><br><span class="line">        messageImp-&gt;<span class="built_in">Connect</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span></span>&#123;</span><br><span class="line">        messageImp-&gt;<span class="built_in">CWriteText</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span></span>&#123;</span><br><span class="line">        messageImp-&gt;<span class="built_in">CDrawShape</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessagerPerfect</span> :</span> <span class="keyword">public</span> Messager &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MessagerPerfect</span>(MessagerImp* mImp) : <span class="built_in">Messager</span>(mImp) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Login</span><span class="params">(string username, string password)</span></span>&#123;</span><br><span class="line">        messageImp-&gt;<span class="built_in">CPlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        messageImp-&gt;<span class="built_in">CConnect</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendMessage</span><span class="params">(string message)</span></span>&#123;</span><br><span class="line">        messageImp-&gt;<span class="built_in">CPlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        messageImp-&gt;<span class="built_in">CWriteText</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SendPicture</span><span class="params">(Image image)</span></span>&#123;</span><br><span class="line">        messageImp-&gt;<span class="built_in">CPlaySound</span>();</span><br><span class="line">        <span class="comment">//********</span></span><br><span class="line">        messageImp-&gt;<span class="built_in">CDrawShape</span>();</span><br><span class="line">        <span class="comment">//........</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="final-4"><ul><li>这里也可以通过抽象工厂自动完成Imp的实现<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Process</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//运行时装配</span></span><br><span class="line">    MessagerImp* mImp=<span class="keyword">new</span> <span class="built_in">PCMessagerImp</span>();</span><br><span class="line">    MessagerLite *mp =<span class="keyword">new</span> <span class="built_in">MessagerLite</span>(mImp);</span><br><span class="line">    MessagerPerfect *ml =<span class="keyword">new</span> <span class="built_in">MessagerPerfect</span>(mImp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></div></div></div></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="story post-story"><ul><li>结构图<img  src=//www.plantuml.com/plantuml/svg/ZP112i8m44NtSufPAf8BY0YjArU2DuZDr0QQJ4a7NDJUtKGhfD2YsINp__j_ec-z15q9LgtkUoocgsMF0s0yWvwUHhnqGQV9PlkUxD2w3aO0FMUSNTUI8oySrXbH537Hd2Uo2lRUYCeH09w5iALQaEkyu7wVyZ6rKCSvbxp1P0FuLBfIRJsPp3mFFZoLuOTNYyA9SM9V1HBAkXNV_Hn9msPXkrLh-TCAa7zaRAWMA_obAk45></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> bridge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式-Decorator</title>
      <link href="/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Decorator/"/>
      <url>/blog/DesignPattern/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-Decorator/</url>
      
        <content type="html"><![CDATA[<blockquote><p>以下笔记摘录自李建忠老师的&lt;&lt;c++设计模式&gt;&gt;和书籍&lt;&lt;设计模式&gt;&gt;</p></blockquote><h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><div class="story post-story"><p>希望给某个对象而不是整个类添加一些功能，或者说动态的给一个对象添加一些额外的职责</p></div><h2 id="原始代码"><a href="#原始代码" class="headerlink" title="原始代码"></a>原始代码</h2><div class="story post-story"><div class="tabs" id="origin"><ul class="nav-tabs"><li class="tab active"><a class="#origin-1">业务操作</a></li><li class="tab"><a class="#origin-2">主体类</a></li><li class="tab"><a class="#origin-3">扩展操作：加密</a></li><li class="tab"><a class="#origin-4">更多可能的组合或扩展：加密、缓冲</a></li></ul><div class="tab-content"><div class="tab-pane active" id="origin-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stream</span>&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">Stream</span>() &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileStream</span> :</span> <span class="keyword">public</span> Stream</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//读文件流</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//定位文件流</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//写文件流</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NetworkStream</span> :</span> <span class="keyword">public</span> Stream</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//读网络流</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//定位网络流</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//写网络流</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MemoryStream</span> :</span> <span class="keyword">public</span> Stream</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//读内存流</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//定位内存流</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//写内存流</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoFileStream</span> :</span> <span class="keyword">public</span> FileStream</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        FileStream::<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        FileStream::<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        FileStream::<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoNetworkStream</span> :</span> <span class="keyword">public</span> NetworkStream</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        NetworkStream::<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        NetworkStream::<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        NetworkStream::<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoMemoryStream</span> :</span> <span class="keyword">public</span> MemoryStream</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        MemoryStream::<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        MemoryStream::<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        MemoryStream::<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="origin-4"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BufferdFileStream</span> :</span> <span class="keyword">public</span> FileStream &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BufferdNetworkStream</span> :</span> <span class="keyword">public</span> NetworkStream &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BufferdMemoryStream</span> :</span> <span class="keyword">public</span> MemoryStream &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoBufferdFileStream</span> :</span> <span class="keyword">public</span> BufferdFileStream &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoBufferdNetworkStream</span> :</span> <span class="keyword">public</span> BufferdNetworkStream &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoBufferdMemoryStream</span> :</span> <span class="keyword">public</span> BufferdMemoryStream &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div></div><ul><li>类的继承关系及扩展组合方式如下：<img  src=//www.plantuml.com/plantuml/svg/IqmgBYbAJ2vH22ufIatCvO9G2ZOrkheARfavgLY4_L9BolEBih78-ARcvXTLGYMu4DeXiiv5bGKb-KY6eYjmAarBIorAmQC2OWIcEYuKDo6hHNKi5cLGmmYgGx4QLJKNih-HLQE41wOYg644LA5OZ2mD0000><ul><li>可以看到随着扩展种类增多，各种组合导致类的数量急剧增加</li></ul></li><li>使用代码如下：<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//编译时装配</span></span><br><span class="line">FileStream * s1 = <span class="keyword">new</span> <span class="built_in">FileStream</span>();</span><br><span class="line">CryptoFileStream * s1 = <span class="keyword">new</span> <span class="built_in">CryptoFileStream</span>();</span><br><span class="line">BufferdFileStream * s2 = <span class="keyword">new</span> <span class="built_in">BufferdFileStream</span>();</span><br><span class="line">CryptoBufferdFileStream * s3 = <span class="keyword">new</span> <span class="built_in">CryptoBufferdFileStream</span>();</span><br></pre></td></tr></table></figure></div><h2 id="重构：-第一个版本，重要的思路转换"><a href="#重构：-第一个版本，重要的思路转换" class="headerlink" title="重构： 第一个版本，重要的思路转换"></a>重构： 第一个版本，重要的思路转换</h2><div class="story post-story"></li><li><code>扩展操作</code>类<strong>由继承改为组合</strong></li></ul><div class="tabs" id="version1"><ul class="nav-tabs"><li class="tab active"><a class="#version1-1">CryptoFileStream</a></li><li class="tab"><a class="#version1-2">CryptoNetworkStream</a></li><li class="tab"><a class="#version1-3">CryptoMemoryStream</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version1-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoFileStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    FileStream * stream;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoNetworkStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    NetworkStream * stream;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version1-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoMemoryStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    MemoryStream * stream;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div></div><h2 id="重构：-第二个版本，充分利用抽象类"><a href="#重构：-第二个版本，充分利用抽象类" class="headerlink" title="重构： 第二个版本，充分利用抽象类"></a>重构： 第二个版本，充分利用抽象类</h2><div class="story post-story"><ul><li><p><code>扩展操作</code>类<strong>子类对象指针改为基类指针，通过不同的初始化方式应不同的子类</strong></p><div class="tabs" id="version2"><ul class="nav-tabs"><li class="tab active"><a class="#version2-1">CryptoFileStream</a></li><li class="tab"><a class="#version2-2">CryptoNetworkStream</a></li><li class="tab"><a class="#version2-3">CryptoMemoryStream</a></li></ul><div class="tab-content"><div class="tab-pane active" id="version2-1"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoFileStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Stream * stream; <span class="comment">// = new FileStream();</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-2"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoNetworkStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Stream * stream; <span class="comment">// = new NetworkStream();</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="version2-3"><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoMemoryStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Stream * stream; <span class="comment">// = new MemoryStream();</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></div></div></div></div><h2 id="重构：-第三个版本，合并简化"><a href="#重构：-第三个版本，合并简化" class="headerlink" title="重构： 第三个版本，合并简化"></a>重构： 第三个版本，合并简化</h2><div class="story post-story"></li><li><p>第二个重构版本中可以发现这三个类其实是完全一样，以合并为一个</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoStream</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Stream * stream; <span class="comment">// = new FileStream(); or new NetworkStream(); or new  MemoryStream();</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>为保留基类虚函数的规范，这个类还要继承<code>Stream</code>类，同时添加了构造函数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoStream</span> :</span> <span class="keyword">public</span> Stream</span><br><span class="line">&#123;</span><br><span class="line">    Stream * stream; <span class="comment">// = new FileStream(); or new NetworkStream(); or new  MemoryStream();</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CryptoStream</span>(Stream * stm) : <span class="built_in">stream</span>(stm) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">        <span class="comment">//额外的加密操作...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>会发现<strong>这个类既继承了基类，又含有基类指针成员，这也是decorator模式的一个重要标志</strong></p></li><li><p>同理<code>buffered</code>扩展就重构为</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BufferedStream</span> :</span> <span class="keyword">public</span> Stream</span><br><span class="line">&#123;</span><br><span class="line">    Stream * stream; <span class="comment">// = new FileStream(); or new NetworkStream(); or new  MemoryStream();</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BufferedStream</span>(Stream * stm) : <span class="built_in">stream</span>(stm) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">char</span> <span class="title">Read</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//额外的buffer操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Read</span>(number);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Seek</span><span class="params">(<span class="keyword">int</span> position)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的buffer操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Seek</span>(position);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Write</span><span class="params">(<span class="keyword">char</span> data)</span></span>&#123;</span><br><span class="line">        <span class="comment">//额外的buffer操作...</span></span><br><span class="line">        stream-&gt;<span class="built_in">Write</span>(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li></ul></div><h2 id="重构：-最后的版本，锦上添花"><a href="#重构：-最后的版本，锦上添花" class="headerlink" title="重构： 最后的版本，锦上添花"></a>重构： 最后的版本，锦上添花</h2><div class="story post-story"><ul><li><p>可以发现第三个版本中<code>CryptoStream</code>和<code>BufferdStream</code>中都有成员指针，那么就可以尝试将其往底层提取</p></li><li><p>一个直接的办法是放置在抽象类<code>Stream</code>中，但这样对三个<code>主题类</code>而言是多余的</p></li><li><p>所以可以再封装一个类<code>DecoratorStream</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecoratorStream</span> :</span> <span class="keyword">public</span> Stream</span><br><span class="line">&#123;</span><br><span class="line">    Stream * stream;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DecoratorStream</span>(Stream * stm) : <span class="built_in">stream</span>(stm) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//扩展操作继承DecoratorStream</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CryptoStream</span> :</span> <span class="keyword">public</span> DecoratorStream</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CryptoStream</span>(Stream * stm) : <span class="built_in">DecoratorStream</span>(stm) &#123;&#125;</span><br><span class="line">&#125;；</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BufferedStream</span> :</span> <span class="keyword">public</span> DecoratorStream</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">BufferedStream</span>(Stream * stm) : <span class="built_in">DecoratorStream</span>(stm) &#123;&#125;</span><br><span class="line">&#125;；</span><br></pre></td></tr></table></figure></li><li><p>使用代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//运行时装配</span></span><br><span class="line">FileStream * s1 = <span class="keyword">new</span> <span class="built_in">FileStream</span>();</span><br><span class="line">CryptoStream * s2 = <span class="keyword">new</span> <span class="built_in">CryptoStream</span>(s1);   <span class="comment">//针对FileStream加密</span></span><br><span class="line">BufferdStream * s3 = <span class="keyword">new</span> <span class="built_in">BufferdStream</span>(s1); <span class="comment">//针对FileStream缓冲</span></span><br><span class="line">BufferdStream * s4 = <span class="keyword">new</span> <span class="built_in">BufferdStream</span>(s2); <span class="comment">//针对FileStream既缓冲又加密</span></span><br></pre></td></tr></table></figure></li></ul></div><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><div class="story post-story"><ul><li>根源分析：某些情况下”过度地使用继承来扩展对象的功能”，<strong>由于继承为类型引入的静态特质</strong>(扩展类中调用子类的<code>Read</code>，<code>Seek</code>，<code>Write</code>)，使得这种扩展方式缺乏灵活性。</li><li>模式定义：动态(组合)的给一个对象增加一些额外的职责。就增加功能而言，Decorator模式比生成子类(继承)更为灵活(消除重复代码&amp;减少子类个数)</li></ul></div>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> decorator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>manim-第一个程序</title>
      <link href="/blog/manim/manim-%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%A8%8B%E5%BA%8F/"/>
      <url>/blog/manim/manim-%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%A8%8B%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<div class="note quote"><p>Manim is an engine for precise programatic animations</p></div><span id="more"></span><h2 id="clone仓库"><a href="#clone仓库" class="headerlink" title="clone仓库"></a>clone仓库</h2><div class="story post-story"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/3b1b/manim.git</span><br></pre></td></tr></table></figure></div><h2 id="运行demo"><a href="#运行demo" class="headerlink" title="运行demo"></a>运行demo</h2><div class="story post-story"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> manim</span><br><span class="line">manimgl example_scenes.py OpeningManimExample</span><br></pre></td></tr></table></figure></div><h2 id="编写一个"><a href="#编写一个" class="headerlink" title="编写一个"></a>编写一个</h2><div class="story post-story"><ul><li><p>在manim目录下新建python文件<code>demo.py</code>，代码如下</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> manimlib.imports <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SquareToCircle</span>(<span class="params">Scene</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">construct</span>(<span class="params">self</span>):</span></span><br><span class="line">        circle = Circle()</span><br><span class="line">        circle.set_fill(BLUE, opacity=<span class="number">0.5</span>)</span><br><span class="line">        circle.set_stroke(BLUE_A, width=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">        square = Square()</span><br><span class="line"></span><br><span class="line">        self.play(ShowCreation(square))</span><br><span class="line">        self.play(ReplacementTransform(square, circle))</span><br><span class="line">        self.wait()</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure></li><li><p>运行程序，执行<code>manim demo.py SquareToCircle</code>，就会展示如下动画<br><video src='https://res.sdking.fun/SquareToCircle.mp4' type='video/mp4' controls='controls'  width='400' height='100%'></video></p><ul><li>执行<code>manim demo.py SquareToCircle -wm</code>可以在videos目录下生成视屏文件</li></ul></li></ul></div><h2 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h2><div class="story post-story"><ul><li><p>定义场景类：</p><ul><li>需要继承自场景类<code>Scene</code></li><li>override函数：<code>construct</code></li></ul>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SquareToCircle</span>(<span class="params">Scene</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">construct</span>(<span class="params">self</span>):</span></span><br></pre></td></tr></table></figure></li><li><p>场景元素添加并设置：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">circle = Circle()</span><br><span class="line">circle.set_fill(BLUE, opacity=<span class="number">0.5</span>)</span><br><span class="line">circle.set_stroke(BLUE_A, width=<span class="number">4</span>)</span><br><span class="line">square = Square()</span><br></pre></td></tr></table></figure></li><li><p>动画定义及播放：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.play(ShowCreation(square))</span><br><span class="line">self.play(ReplacementTransform(square, circle))</span><br></pre></td></tr></table></figure><p>以上。</p></li></ul></div>]]></content>
      
      
      <categories>
          
          <category> manim </category>
          
      </categories>
      
      
        <tags>
            
            <tag> manim </tag>
            
            <tag> math </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
